@startuml
' OpsMind — C4 Component Diagram (Orchestrator internals)
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

LAYOUT_LEFT_RIGHT()
title OpsMind — Orchestrator Component Diagram (Developer-level)

Container_Boundary(orchestrator, "Orchestrator Service ") {

  Component(turnHandler, "Turn Handler", "OrchestratorTurnService", "Entry point per user message. Loads state, routes scenario, plans tools, updates state, returns ResponseModel.")

  Component(stateManager, "ConversationState Manager", "StateManager", "Load/save ConversationState. Applies context overrides. Maintains rolling summary window.")
  
  Component(slotFiller, "Slot Validator & Filler", "SlotEngine", "Checks required slots by scenario; emits follow-up questions; updates open_questions.")
  
  Component(router, "Scenario Classifier", "ScenarioRouter", "Classifies into 500 spike / latency / regional outage / generic RCA (rules + optional LLM).")

  Component(workflow, "Workflow Engine", "DeterministicWorkflowEngine", "Implements bounded state machine per scenario: scope->plan->gather->hypothesize->respond.")
  
  Component(planner, "Tool Planner", "ToolPlanner", "Builds ordered tool plan from ScenarioWorkflowSpec with budgets (max calls/runtime).")
  
  Component(toolRegistry, "Tool Registry", "ToolRegistry", "Executes tools through adapters; writes ToolCall ledger; returns ToolResult summaries.")
  
  Component(evidence, "Evidence Enforcer", "EvidencePolicy", "Validates evidence-first: each hypothesis must cite ToolResult/Artifact; degrades to 'needs_info' if insufficient.")
  
  Component(hypothesis, "Hypothesis Builder", "HypothesisEngine", "Turns tool results into 1-3 hypotheses w/ confidence and evidence refs; maintains hypothesis lifecycle.")
  
  Component(presenter, "Presenter", "ResponsePresenter", "Builds ResponseModel for UI/Slack/Teams renderers (primary_text, hypotheses, evidence, next_actions, followups).")

  Component(modelProvider, "Model Provider Adapter", "ModelProvider", "LLM abstraction. Implementations: Mock, Vertex, Bedrock, OpenAI.")
}

ContainerDb(redis, "Redis", "Hot cache", "Rolling summary, slots snapshot, workflow state, last N messages (TTL).")

ContainerDb(pg, "Postgres", "Durable store", "Full transcript, tool ledger, feedback, audit metadata.")

ContainerDb(obj, "Object Store", "GCS/S3", "Raw tool outputs, artifacts, exports.")

System_Ext(logs, "Logs backend", "Cloud Logging/Splunk/ELK")
System_Ext(metrics, "Metrics backend", "Prometheus/Cloud Monitoring/Datadog")
System_Ext(traces, "Traces backend", "Tempo/Jaeger/Cloud Trace/X-Ray")
System_Ext(changes, "Deploy/Change backend", "CI/CD + Change Mgmt APIs")
System_Ext(config, "Config/Flags backend", "AppConfig/LaunchDarkly/Config service")

Rel(turnHandler, stateManager, "Load/Save state")
Rel(turnHandler, router, "Classify scenario")
Rel(turnHandler, slotFiller, "Check required slots\nEmit follow-ups")
Rel(turnHandler, workflow, "Advance workflow state")
Rel(workflow, planner, "Build tool plan")
Rel(planner, toolRegistry, "Execute tool plan")
Rel(toolRegistry, logs, "Query logs")
Rel(toolRegistry, metrics, "Query metrics")
Rel(toolRegistry, traces, "Query traces")
Rel(toolRegistry, changes, "Query deploy/change events")
Rel(toolRegistry, config, "Query config/flags")

Rel(toolRegistry, obj, "Store raw outputs", "HTTPS")
Rel(stateManager, redis, "Hot read/write", "Redis")
Rel(stateManager, pg, "Durable read/write", "SQL")

Rel(workflow, hypothesis, "Update hypotheses from tool results")
Rel(hypothesis, evidence, "Validate evidence requirements")
Rel(evidence, presenter, "Allow/annotate response")
Rel(turnHandler, presenter, "Return ResponseModel")

Rel(turnHandler, modelProvider, "Optional LLM calls\n(classify/summarize/synthesize)", "HTTPS")

@enduml